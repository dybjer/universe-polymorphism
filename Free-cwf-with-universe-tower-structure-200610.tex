\documentclass{lmcs}
%\usepackage{etex}
\usepackage[utf8]{inputenc}

\usepackage{color}
\usepackage{hyperref}
\usepackage{float}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amsthm}
\usepackage{amssymb}
\usepackage{proof}
\usepackage{mathpartir}
\usepackage{mathrsfs}
\usepackage{stmaryrd}
\usepackage{cmll}
\usepackage{enumerate}
\usepackage{graphicx}
\usepackage[all]{xy}
\usepackage{listings}
\usepackage{todonotes}
\usepackage{Guyboxes}
\input{macros}
\input{newmacros}
\newcommand{\s}{\mathrm{s}}
\newcommand{\Rec}{\mathrm{R}}
\newcommand{\Ta}{\mathrm{T}}
\newcommand{\ta}{\mathrm{t}}
\newcommand{\Ru}{\mathcal{R}}
\newcommand{\Nhat}{\hat{\N}}
\newcommand{\Pihat}{\hat{\Pi}}
\newcommand{\Tan}{\Ta_n}
\newcommand{\Un}{\U_n}
\newcommand{\Nhatn}{\N^n}
\newcommand{\Pihatn}{\Pi^n}
\newcommand{\Nn}{\Nhatn}
\newcommand{\Pin}{\Pihatn}
\newcommand{\TRu}{\Ta_\Ru}
\newcommand{\URu}{\U_\Ru}
\newcommand{\NRu}{\N_\Ru}
\newcommand{\PiRu}{\Pi_\Ru}
\newcommand{\TRun}{{(\Ta_\Ru)}_n}
\newcommand{\URun}{{(\U_\Ru)}_n}
\newcommand{\NRun}{{(\N_\Ru)}^n}
\newcommand{\PiRun}{{(\Pi_\Ru)}^n}
\newcommand{\TRum}{{(\Ta_\Ru)}_m}
\newcommand{\URum}{{(\\U_\Ru)}_m}
\newcommand{\TC}{\Ta_\C}
\newcommand{\UC}{\U_\C}
\newcommand{\NC}{\N_\C}
\newcommand{\PiC}{\Pi_\C}
\newcommand{\Level}{\mathrm{Level}}

\title[Initial Cwfs with Universe Tower Structures]{Initial Cwfs with Universe Tower Structures}

\begin{document}

\begin{abstract}
We define the notion of a universe tower structure on a cwf. We show how to build initial cwfs with universe tower structures in two ways: a la Tarski and a la Russell. Moreover, we consider both systems without and with cumulativity.
\end{abstract}

\maketitle

\section{Introduction}

We formulate both a non-cumulative and a cumulative notion of universe tower structure on a cwf. We construct initial such structures a la Tarski. In the cumulative case we can also construct it a la Russell. 

Both notions can be formalized as generalized algebraic theories giving rise to internal notions of cwfs with universe structures. These have initial models by a general result. 

We follow the general recipe of constructing initial models as presented in "Undecidability of equality in the free locally cartesian closed category" by Castellan, Clairambault, and Dybjer. In that paper an initial cwf with structure for extensional $\I$-types, $\N_1, \Sigma, \Pi$ and a base type is constructed. This initial model is built by defining raw terms from cwf-combinators and combinators for the constants associated with extensional $\I$-types, $\N_1, \Sigma, \Pi$, and then for each equality judgment defining a partial equivalence relation, yielding a name-free version of type theory with explicit substitutions with rules for the type formers in question.

This construction can be extended in a straightforward way to cwfs with universe towers. This yields formulations a la Tarski for both non-cumulative and cumulative towers. We present these constructions below.

We also present formulations a la Russell of non-cumulative and cumulative universe towers. We prove that the cumulative version yields an initial model, and hence is equivalent to the a la Tarski formulation. 

For simplicity we consider a basic type theory with $\N$ and $\Pi$ as the only small type formers. 

We begin by reviewing the three versions of universe hierachies in Martin-Löf's original papers on type theory. The rules are written in the name-free notation used in the sequel of the note.

\subsection*{Martin-Löf 1973}

The first formulation of type theory with a tower of universes is a version without cumulativity. The introduction rules for $\Un$ are as follows:
%(Present the version with names.)
\begin{mathpar}
 	\inferrule
		{\Gamma \vdash} 
		{\Gamma \vdash \N : \U_0}
	\and 
	\inferrule
		{\Gamma \vdash a : \U_m
		\and
		\Gamma \cdot a \vdash b : \Un}
		{\Gamma \vdash \Pi(a,b) : \U_{m \vee n}}
		\and 
        \inferrule
		{\Gamma \vdash} 
		{\Gamma \vdash \Un : \U_{n+1}} 
  \end{mathpar}
In this way each type lives in a unique universe. This theory has untyped equality judgments.

\subsection*{Martin-Löf 1979}

This is the first version with a cumulative tower:

\begin{mathpar}
 	\inferrule
		{\Gamma \vdash} 
		{\Gamma \vdash \N : \U_n}
	\and 
	\inferrule
		{\Gamma \vdash a : \U_n
		\and
		\Gamma \cdot a \vdash b : \Un}
		{\Gamma \vdash \Pi(a,b) : \U_n}
		\and 
        \inferrule
		{\Gamma \vdash} 
		{\Gamma \vdash \U_m : \U_n} 
		\ m < n
  \end{mathpar}
\begin{mathpar}
	\inferrule
		{\Gamma \vdash a : \U_n}
		{\Gamma \vdash \U_n}
	\and 
 	\inferrule
		{\Gamma \vdash a : \U_n} 
		{\Gamma \vdash a : \U_{n+1}}
  \end{mathpar}
There are also corresponding rules for the equality judgments.
All rules are validated by the meaning explanations given in that paper.

\subsection*{Martin-Löf 1984}
This contains the first formulation of universes a la Tarski. Rules are only given for the first universe $\U_0$, with a brief explanation of how to add a second universe $\U_1$, and a third universe $\U_2$, etc. In this version there is a lifting operation 
\begin{mathpar}
 	\inferrule
		{\Gamma \vdash a : \U_0} 
		{\Gamma \vdash \Ta_0^1(a) : \U_1}
  \end{mathpar}
  with $\Ta_1(\Ta_0^1(a)) = \Ta_0(a)$. However, there are no rules such as $\Ta_0^1(\N^0) = \N^1$, etc.

\subsection*{Plan}

We first consider a formulation of universes without cumulativity. We differ from Martin-Löf 1973 in that we have $\Gamma \vdash \N : \U_n$ for all $n$ rather than $\Gamma \vdash \N : \U_0$ only. The reason is that we do not identify universe levels with natural numbers. Instead our levels have the algebraic structure of $\vee$-semilattices with a successor operation $n+1$, but no $0$.

For this non-cumulative case we define the notion of universe tower structure on a cwf and show how to build initial cwfs with universe tower structures both a la Tarski and a la Russell. 

We then define cumulative universe tower structures on cwfs and build initial such a la Tarski and a la Russell. The formulation a la Russell is similar to Martin-Löf 1979, whereas the formulation a la Tarski differs from Martin-Löf 1984, since it has rules such as $\Ta_m^n(\N^m) = \N^n$, etc.

\section{A universe tower structure on a cwf}

A universe tower structure on a cwf with $\Pi, \N$-structures consists of the following.
\begin{itemize}
\item 
At each level $n$ we have types ${(\Un)}_\Gamma \in \Ty(\Gamma)$ for all contexts $\Gamma$ and functions $\Ta_n : \Tm(\Gamma,{(\U_n)}_\Gamma) \to \Ty(\Gamma)$. These are closed under $\N$ and $\Pi$ in the sense that there are codes $\N^0_\Gamma \in \Tm(\Gamma,{(\U_0)}_\Gamma)$ and $\Pi^{m,n} : (a \in \Tm(\Gamma,{(\U_m)}_\Gamma)) \to \Tm(\Gamma \cdot \Tan(a),{(\Un)}_{\Gamma \cdot \Tan(a)}
) \to \Tm(\Gamma,{(\U_{m\vee n})}_\Gamma)$ such that 
\begin{eqnarray*}
\Tan(\N^0_\Gamma) &=& \N_\Gamma\\
\Ta_{m \vee n}(\Pi^{m,n}(a,b)) &=& \Pi(\Ta_m(a),\Tan(b))
\end{eqnarray*}
\item
The universe at each level has a code in the next: $(\U^n)_\Gamma \in \Tm(\Gamma,\U_{n+1})$ such that 
\begin{eqnarray*}
\Ta_{n+1}((\U^n)_\Gamma ) &=& (\U_n)_\Gamma
\end{eqnarray*}
\item
Finally, all operations commute with substitution: if $\gamma : \Delta \to \Gamma$, then
\begin{eqnarray*}
{(\Un)}_\Gamma [ \gamma ] &=& {(\Un)}_\Delta\\
\Tan(a) [ \gamma ] &=& \Tan(a[ \gamma ] )\\
\N^0_\Gamma [ \gamma ] &=&\N^0_\Delta\\
\Pi^{m,n}(a,b)[ \gamma ] &=& \Pi^{m,n}(a [ \gamma ], b[ \gamma^+ ])\\
\U^n[\gamma] &=& \U^n
\end{eqnarray*}
\end{itemize}
Cwfs with universe tower structures form a generalized algebraic theory in Cartmell's sense. We have written the rules and axioms in an informal style, omitting some arguments of the operations.
To see that we really have an generalized algebraic theory we need, in addition to the original four sort symbols for the generalised algebraic theory of cwfs, a new sort symbol $\Level$
%$\mathbb{N}$ 
for the external natural numbers serving as universe levels and also operator symbols $0, n^+, m \vee n$, for zero, successor, and supremum of levels. \footnote{Be consistent about using $n^+$ and $n+1$.} We have the following equations:
\begin{eqnarray*}
m \vee 0 &=&m\\
0 \vee n &=& n\\
m^+ \vee n^+ &=& (m \vee n)^+
\end{eqnarray*}
If we work in an intensional setting we may also want the equations for a $\vee$-semilattice and
\begin{eqnarray*}
n^+ \vee n &=& n^+\\
m^+ \vee n^+ &=& (m \vee n)^+
\end{eqnarray*}

{\bf Remark}. In the universe polymorphic system that we are going to show later, we instead have the operator symbols $\alpha_i, n^+, m \vee n$, where $\alpha_i$ is a level variable, and we have the equations for a $\vee$-semilattice and also 
\begin{eqnarray*}
n^+ \vee n &=& n^+\\
m^+ \vee n^+ &=& (m \vee n)^+
\end{eqnarray*}

{\bf Remark}. We will later introduce universes with cumulativity.

\section{An initial cwf with a universe tower a la Tarski}

This construction is a straightforward modification of the construction in Castellan et al. 
%It is an instance of the general result that any generalized algebraic theory has an initial model. 

\subsection{Raw terms}

Add the following productions:
\begin{eqnarray*}
m, n \in \mathbb{N} &::=& 0 \mid n^+ \mid m \vee n\\
A \in \RawTy &::=& \Un \mid \Tan(a)\\
a,b \in \RawTm &::=&  \Nhatn \mid \Pi^{m,n}(a,b) \mid \U^n 
\end{eqnarray*}

\subsection{Inference rules}

We add inference rules for universe towers that mirror the definition of the universe tower structure of a cwf. We have the following equations for level numbers:
\begin{eqnarray*}
m \vee 0 &=&m\\
0 \vee n &=& n\\
m^+ \vee n^+ &=& (m \vee n)^+
\end{eqnarray*}

First, we have rules expressing that $\Un$ is a universe closed under $\Pi$ and $\N$
\footnote{Change to Martin-Löf's system where $\N$ is only in $\U_0$}:
%\begin{figure}
%  \centering
%  \label{fig:cwf4}
%\boxit[Rules for the universe a la Tarski]{
 \begin{mathpar}
     	\inferrule
		{\Gamma \vdash} 
		{\Gamma \vdash {\Un}} 
	\and
    	\inferrule
		{\Gamma \vdash a : {\Un} } 
		{\Gamma \vdash \Tan(a)}
	\and
    	\inferrule
		{\Gamma \vdash a = a'  : {\Un} } 
		{\Gamma \vdash \Tan(a) = \Tan(a')}
	\and 
	\inferrule
		{\Gamma \vdash} 
		{\Gamma \vdash \N^0 : {\U_0}}
	\and 
	\inferrule
		{\Gamma \vdash a : {\U_m} 
		\and
		\Gamma\cdot\Tan(a) \vdash b : {\Un}} 
		{\Gamma \vdash \Pi^{m,n}(a,b) : {\U_{m \vee n}} }
	\and 
	\inferrule
		{\Gamma \vdash a = a' : {\U_m} 
		\and
		\Gamma\cdot\Tan(a) \vdash b = b' : {\Un}} 
		{\Gamma \vdash \Pi^{m,n}(a,b) =   \Pi^{m,n}(a',b'): {\U_{m \vee n}} }
\end{mathpar}
Remark: Note that the second and fifth rule above are instances of the third and fifth, respectively.
\begin{mathpar}
	\inferrule
		{\Gamma \vdash} 
		{\Gamma \vdash \Tan(\N^0) = \N}
        \and 
	\inferrule
		{\Gamma \vdash a : {\U_m} 
		\and 
		\Gamma\cdot\Tan(a) \vdash b : {\Un} } 
		{\Gamma \vdash \Ta_{m \vee n}(\Pi^{m,n}(a,b)) = \Pi(\Ta_m(a),\Tan(b))}
  \end{mathpar}

Then there are rules for the code for a universe in the next:
\begin{mathpar}
	\inferrule
		{\Gamma \vdash} 
		{\Gamma \vdash \U^n : {\U_{n+1}}}
	\and 
	\inferrule
		{\Gamma \vdash} 
		{\Gamma \vdash \Ta_{n+1}(\U^n) = \U_n}
\end{mathpar}

Finally, all operations commute with substitution
 \begin{mathpar}
     	\inferrule
		{\Delta \vdash \gamma : \Gamma} 
		{\Delta \vdash {\Un}[\gamma] = {\Un}} 
	\and
    	\inferrule
		{\Gamma \vdash a : {\Un}
		\and
		\Delta \vdash \gamma : \Gamma } 
		{\Delta \vdash \Tan(a)[\gamma] = \Tan(a[\gamma])}
\end{mathpar}
\begin{mathpar}
	\inferrule
		{
		\Delta \vdash \gamma : \Gamma} 
		{\Delta \vdash \N^0[\gamma] = \N^0 : {\Un}}
	\and 
	\inferrule
		{\Gamma \vdash a : {\Un} 
		\and
		\Gamma\cdot\Tan(a) \vdash b : {\Un}
		\and
		\Delta \vdash \gamma : \Gamma} 
		{\Delta \vdash \Pi^{m,n}(a,b)[\gamma] = \Pi^{m,n}(a[\gamma],b[\gamma^+]) : {\Un} }
	\and
	\inferrule
		{
		\Delta \vdash \gamma : \Gamma} 
		{\Delta \vdash \U^n[\gamma] = \Un : \U_{n+1}}

\end{mathpar}

\subsection{The initial cwf.}
We can now define the initial cwf $\T$ with $\Pi, \N$ and a universe tower structure following the pattern in Castellan et al. The contexts, context morphisms, types, and terms of $\T$ will all be equivalence classes of well-formed raw contexts, raw context morphisms, raw types, and raw terms, respectively. However, we will in the sequel omit the equivalence class brackets, and write $\Gamma$ for a $\T$-context $[\Gamma]$, etc.

\subsection{The initial cwf-morphism} Let $\C$ be a cwf with $\Pi, \N$, and a universe tower structure. We define the initial cwf-morphism as in Castellan et al and have the following clauses for the universe tower structure:
\begin{eqnarray*}
\inte{\Un}_\Gamma &=& ((\UC)_n)_{\inte{\Gamma}}\\
\inte{\Tan(a)}_\Gamma &= & (\Ta_\C)_n(\inte{a}_{\Gamma,\Un})\\
\inte{\N^0}_{\Gamma,\Un} &=&  {({({\NC})^0})}_{\inte{\Gamma},((\UC)_0)_{\inte{\Gamma}}}\\
\inte{\Pi^{m,n}(a,b)}_{\Gamma,\U_{m \vee n}} &=&  (\PiC)^{m,n}(\inte{a}_{\Gamma,\U_m},\inte{b}_{\Gamma \cdot \Tan(a),\Un})\\
\inte{\U^n}_{\Gamma,\U_{n+1}} &=&  {({({\UC})^n})}_{\inte{\Gamma},((\UC)_{n+1})_{\inte{\Gamma}}}%\\
%\inte{\Tan^{n+1}(a)}_\Gamma &= & (\Ta_\C)^{n+1}_n(\inte{a}_{\Gamma,\Un})
\end{eqnarray*}
We then extend the proofs that $\Gamma \vdash A$ implies that $\inte{A}_\Gamma$ is defined and $\Gamma \vdash a : A$ implies that $\inte{a}_{\Gamma,A}$ is defined, and similarly for the equality judgments. 

\subsection{Uniqueness of the initial cwf-morphism} This can be proved in the same way as Theorem 3.8 in Castellan et al.

\section{An initial cwf with a universe tower a la Russell}

\subsection{Raw terms}

We combine raw types and raw terms into one syntactic category.
We combine all the previous productions for raw types and raw terms and add the following new production:
\begin{eqnarray*}
a \in \RawTm &::=&  \Un
\end{eqnarray*}

\subsection{Inference rules}

The inference rules for cwfs are as in Castellan et al except that they now range over the combined syntactic category $\RawTm$.

We add the following new inference rules expressing that $\Un$ is a universe closed under $\Pi$ and $\N$:
%\begin{figure}
%  \centering
%  \label{fig:cwf4}
%\boxit[Rules for the universe a la Russell]{
  \begin{mathpar}
     	\inferrule
		{\Gamma \vdash} 
		{\Gamma \vdash \Un} 
	\and 
	\inferrule
		{\Gamma \vdash} 
		{\Gamma \vdash \N : \U_0}
	\and 
	\inferrule
		{\Gamma \vdash a : \U_m
		\and
		\Gamma \cdot a \vdash b : \Un}
		{\Gamma \vdash \Pi(a,b) : \U_{m \vee n}}
  \end{mathpar}
We also need 
  \begin{mathpar}
 	\inferrule
		{\Gamma \vdash a = a' : \U_m
		\and
		\Gamma \cdot a \vdash b = b': \Un}
		{\Gamma \vdash \Pi(a,b) = \Pi(a',b') : \U_{m \vee n}}
  \end{mathpar}
which makes the third rule redundant.

Each universe is in the next higher one:
\begin{mathpar}
     	\inferrule
		{\Gamma \vdash} 
		{\Gamma \vdash \U_n : \U_{n+1}}
\end{mathpar}
Remark. It follows that
%\begin{mathpar}
%    \inferrule
%		{\Gamma \vdash a : \Un } 
%		{\Gamma \vdash a}
%  \end{mathpar}
%  and also that if 
$\Gamma \vdash a$ iff there is an $n$ such that $\Gamma \vdash a : \Un$.
  
  Finally, all operations commute with substitution:
   \begin{mathpar}
     	\inferrule
		{\Delta \vdash \gamma : \Gamma} 
		{\Delta \vdash \Un[\gamma] = \Un} 
	\and 
	\inferrule
		{\Delta \vdash \gamma : \Gamma} 
		{\Delta \vdash \N[\gamma] = \N : \U_0}
	\and 
	\inferrule
		{\Gamma \vdash a : \Un
		\and
		\Gamma \cdot a \vdash b : \Un
		\and
		\Delta \vdash \gamma : \Gamma}
		{\Delta \vdash \Pi(a,b)[\gamma] = \Pi(a[\gamma],b[\gamma^+]) : \U}
	\and
	\inferrule
		{\Gamma \vdash} 
		{\Gamma \vdash \U_n[\gamma] = \U_n : \U_{n+1}}
  \end{mathpar}
  
\subsection{The initial cwf}

We now build the initial cwf $\Ru$ with a universe tower structure by modifying Castellan et al. Note that the notion of universe tower structure is a la Tarski, so we need to define the Tarski-style operations in terms of the Russell ones.

Let $\Gamma \vdash$, $\Gamma \vdash a : \U_m$, and $\Gamma \cdot a \vdash b : \Un$. We have
\begin{eqnarray*}
({\URun})_\Gamma &=& \Un  \in \Ty_\Ru(\Gamma)\\
(\TRu)_m(a) &=& a \in \Ty_\Ru(\Gamma)\\
({(\NRu)^0})_\Gamma &=& \N \in \Tm_\Ru(\Gamma,\Un)\\
(\PiRu)^{m,n}(a,b) &=& \Pi(a,b) \in \Tm_\Ru(\Gamma,\U_{m \vee n})\\
(({\URu})^n)_\Gamma &=& \Un  \in \Tm_\Ru(\Gamma,\U_{n+1})
\end{eqnarray*}
It follows that 
$$
\TRun(((\NRu)^0)_\Gamma)  =  \N = {(\NRu)}_\Gamma \in \Ty_\Ru(\Gamma)
$$
$$
(\TRu)_{m \vee n}(\PiRu^{m,n}(a,b)) = \Pi(a,b) = \PiRu((\TRu)_m(a),\TRun(b))\in \Ty_\Ru(\Gamma)
$$
$$
\TRun(((\URu)^n)_\Gamma)  =  \Un = ({(\URu)_n})_\Gamma \in \Ty_\Ru(\Gamma)
$$
We also need to check that substitution commutes with all the new operations.

\subsection{The initial cwf-morphism}

Let $\C$ be a cwf with $\Pi, \N$, and a universe tower structure. We now define the initial cwf-morphism on raw terms as in Castellan et al with the following new clauses:
\begin{eqnarray*}
\inte{\Un}_\Gamma &=& {({({\UC})_n})}_{\inte{\Gamma}}\\
\inte{\N}_{\Gamma,\U_0} &=&  {({({\NC})^0})}_{\inte{\Gamma},((\UC)_0)_{\inte{\Gamma}}}\\
\inte{\Pi(a,b)}_{\Gamma,\U_{m \vee n}}&=& {{({\PiC})^{m,n}}}(\inte{a}_{\Gamma,\U_m},\inte{b}_{\Gamma \cdot a,\Un})\\
\inte{\U_n}_{\Gamma,\U_{n+1}} &=& {({({\UC})^n})}_{\inte{\Gamma},((\UC)_{n+1})_{\inte{\Gamma}}}
\end{eqnarray*}
Note that the clause for $\Pi(a,b)$ does not work, since $m \vee n$ does not determine $m$ and $n$ uniquely. (If we assume decidable type-checking, we can check $\Gamma \vdash a : \U_p$ and $\Gamma \cdot a \vdash b : \U_p$ for $p \leq m \vee n$.)

%The following are obsolete clauses from the cumulative case:
%\begin{eqnarray*}
%\inte{\Pi(a,b)}_{\Gamma,\Un} &=& {({({\PiC})^n})}(\inte{a}_{\Gamma,\Un},\inte{b}_{\Gamma \cdot a,\Un})\\
%%\inte{\Un}_{\Gamma,\U_{n+1}} &=& {({({\UC})^n})}_{\inte{\Gamma},((\UC)_{n+1})_{\inte{\Gamma}}} \texttt{ (obsolete)}\\
%\inte{\U_m}_{\Gamma,\U_{n}} &=& 
%(\TC)^n_m{({({\UC})^m})}_{\inte{\Gamma},((\UC)_{n})_{\inte{\Gamma}}}\ (m < n)
%\end{eqnarray*}
({\bf The rest of this section needs to be rechecked.}
We can then also extend the proofs (by induction on derivations) that $\Gamma \vdash A$ implies that $\inte{A}_\Gamma$ is defined and $\Gamma \vdash a : A$ implies that $\inte{a}_{\Gamma,A}$ is defined, and similarly for the equality judgments. 

We need to prove that all operations are preserved by $\inte{-}$. For example, we can prove that 
$$
\inte{(\TRu)_n(a)}_\Gamma = (\TC)_n(\inte{a}_{\Gamma,\U})
$$
for $\Gamma \vdash a : \U$ by induction on the derivation.
% ( $\PiRu$ and $\TRu^{n+1}_n$.)
One of the cases is the rule
$$
\inferrule
		{\Gamma \vdash} 
		{\Gamma \vdash \N : \U_0}
$$
we have
$$
\inte{(\Ta_\Ru)_0(\N)}_\Gamma = \inte{\N}_\Gamma = {(\N_\C)}_\Gamma = (\Ta_\C)_0((\NC)^0) = (\Ta_\C)_0(\inte{\N}_{\Gamma,\U_0})
$$

\subsection{Uniqueness of the initial cwf-morphism}

We can also extend the uniqueness proof. We assume another cwf-morphism $F : \Ru \to \C$ (preserving all the structure) and prove it equal to $\inte{-} : \Ru \to \C$. As in the proof of Theorem 3.8 in loc.cit, we do induction on the inference rules. We need to prove a few new cases. For example, for the rule
$$
\inferrule
		{\Gamma \vdash} 
		{\Gamma \vdash \N : \U_0}
$$
we have
$$
F_{\Gamma,\U_0}(\N) =  {({({\NC})^0})}_{F(\Gamma),((\UC)_0)_{F(\Gamma)}} =  {({({\NC})^0})}_{\inte{\Gamma},((\UC)_0)_{\inte{\Gamma}}} = \inte{\N}_{\Gamma,\U_0}
$$
)
\section{Cwfs with cumulative universe tower structures}

We add the following operations and equations to a cwf with a universe tower structure:
\newline
\begin{itemize}
\item 
There are cumulativity operations at each level: $\Ta^n_m : \Tm(\Gamma,\U_m) \to \Tm(\Gamma,\U_n)$ such that
$\Ta^n_m((\N^m)_\Gamma) = (\N^n)_\Gamma$, $\Ta^{n}_m(\Pi^m(a,b)) = \Pi^{n}(\Ta^{n}_m(a),\Ta^{n}_m(b))$, and $\Ta^{n+1}_{m+1}((\U^m)_\Gamma = (\U^{n})_\Gamma$.
\item
These operations commute with substitution:
$\Ta^n_m(a)[\gamma]  = \Ta^n_m(a[\gamma])$.
\end{itemize}
%\newline

Moreover, in the cumulative case we only need to have one operation $\Pi^n$ for each level $n$, and not a doubly indexed family of operations $\Pi^{m,n}$:
\newline
\begin{itemize}
\item 
$\Pi^n : (a \in \Tm(\Gamma,{(\U_n)}_\Gamma)) \to \Tm(\Gamma \cdot \Tan(a),{(\Un)}_\Gamma) \to \Tm(\Gamma,{(\U_{n})}_\Gamma)$
\end{itemize}

Cwfs with cumulative universe tower structurea form a generalized algebraic theory.
%Alternative formulation:
%\begin{itemize}
%\item 
%There are cumulativity operations at each level: $\Ta^{n+1}_n : \Tm(\Gamma,\Un) \to \Tm(\Gamma,\U_{n+1})$ such that
%$\Ta^{n+1}_n((\Nn)_\Gamma) = (\N^{n+1})_\Gamma$, $\Ta^{n+1}_n(\Pin(a,b)) = \Pi^{n+1}(\Ta^{n+1}_n(a),\Ta^{n+1}_n(b))$, and $\Ta^{n+2}_{n+1}((\U^n)_\Gamma = (\U^{n+1})_\Gamma$.
%\item
%These operations commute with substitution:
%$\Ta^{n+1}_n(a)[\gamma]  = \Ta^{n+1}_n(a[\gamma])$.
%\end{itemize}

\section{An initial cwf with a cumulative universe tower structure a la Tarski}

\subsection{Raw terms}
Add the following production to the productions of the non-cumulative universe structure case:
\begin{eqnarray*}
a \in \RawTm &::=&  \Ta_m^n(a)
%a \in \RawTm &::=&  \Ta_n^{n+1}(a)
\end{eqnarray*}

\subsection{Inference rules}
Add the following inference rules:
%\begin{mathpar}
%	\inferrule
%		{\Gamma \vdash a : \U_n} 
%		{\Gamma \vdash \Ta^{n+1}_n(a) : {\U_{n+1}}}
%\end{mathpar}
%\begin{mathpar} 
%	\inferrule
%		{\Gamma \vdash} 
%		{\Gamma \vdash \Ta^{n+1}_n(\Nn) = \N^{n+1} : \U_{n+1}}
%	\and 
%	\inferrule
%		{\Gamma \vdash a : \Un
%		\and 
%		\Gamma\cdot\Ta_n(a) 
%		\vdash b : {\U_n} 
%		}
%		{\Gamma \vdash \Ta^{n+1}_n(\Pin(a,b)) = \Pi^{n+1}(\Ta^{n+1}_n(a),\Ta^{n+1}_n(b)) : \U_{n+1}}
%\end{mathpar}
%\begin{mathpar} 
%	\inferrule
%		{\Gamma \vdash} 
%		{\Gamma \vdash \Ta^{n+2}_{n+1}(\U^n) = \U^{n+1} : \U_{n+2}}
%\end{mathpar}
%We can then define $\Ta^{n+k}_n$ by repeated application of $\Ta^{n+1}_n$. 
%
%\paragraph{Remark.}
%Alternatively, we can directly define $\Ta^n_m$ for $m \leq n$ as a primitive:
\begin{mathpar}
	\inferrule
		{\Gamma \vdash a : \U_m} 
		{\Gamma \vdash \Ta^n_m(a) : {\Un}}
		\ m \leq n
\end{mathpar}
\begin{mathpar} 
	\inferrule
		{\Gamma \vdash} 
		{\Gamma \vdash \Ta^n_m(\N^m) = \N^n : \Un}
	\and 
	\inferrule
		{\Gamma \vdash a : {\U_m}
		\and 
		\Gamma\cdot\Ta_m(a) 
		\vdash b : {\U_m} 
		}
		{\Gamma \vdash \Ta^n_m(\Pi^m(a,b)) = \Pi^n(\Ta^n_m(a),\Ta^n_m(b)) : \Un}
\end{mathpar}
\begin{mathpar} 
	\inferrule
		{\Gamma \vdash} 
		{\Gamma \vdash \Ta^{n+1}_{m+1}(\U^m) = \U^{n} : \U_{n+1}}
		\ m \leq n
\end{mathpar}
It follows that $\Ta^n_n(a) = a$ and $\Ta^p_n\Ta^n_m = \Ta^p_m$.

\subsection{The initial cwf} As for the non-cumulative case, we build the initial cwf in the cumulative case in the same way as the initial cwf in Castellan et al.  And again it is an instance of the general result that any generalized algebraic theory has an initial model.
%We extend the construction for the non-cumulative case in the obvious way. We define the cumulativity operation in this cwf as follows:
%\begin{eqnarray*}
%(\TRu)^n_m(a) &=& a \in \Tm_\Ru(\Gamma,(\URu)_n)
%\end{eqnarray*}
%if $a \in \Tm_\Ru(\Gamma,(\URu)_m)$.

\subsection{The initial cwf-morphism} Let $\C$ be a cwf with $\Pi, \N$, and a cumulative universe tower structure. We extend the definition the initial cwf-morphism in the non-cumulative case with the case
\begin{eqnarray*}
%\inte{\Un}_\Gamma &=& ((\UC)_n)_{\inte{\Gamma}}\\
%\inte{\Tan(a)}_\Gamma &= & (\Ta_\C)_n(\inte{a}_{\Gamma,\Un})\\
%\inte{\Nn}_{\Gamma,\Un} &=&  {({({\NC})^n})}_{\inte{\Gamma},((\UC)_n)_{\inte{\Gamma}}}\\
%\inte{\Pin(a,b)}_{\Gamma,\Un} &=&  (\PiC)^n(\inte{a}_{\Gamma,\Un},\inte{b}_{\Gamma \cdot \Tan(a),\Un})\\
%\inte{\U^n}_{\Gamma,\U_{n+1}} &=&  {({({\UC})^n})}_{\inte{\Gamma},((\UC)_{n+1})_{\inte{\Gamma}}}\\
\inte{\Ta^n_m(a)}_{\Gamma,\U_n} &= & (\Ta_\C)^n_m(\inte{a}_{\Gamma,\U_m})
\end{eqnarray*}
We then extend the proofs that $\Gamma \vdash A$ implies that $\inte{A}_\Gamma$ is defined and $\Gamma \vdash a : A$ implies that $\inte{a}_{\Gamma,A}$ is defined, and similarly for the equality judgments. 

\subsection{Uniqueness of the initial cwf-morphism} As before, this can be proved in the same way as Theorem 3.8 in Castellan et al.

\section{An initial cwf with a cumulative universe tower a la Russell}

\subsection{Raw terms} These are the same as in the non-cumulative case a la Russell, that is, we combine raw types and raw terms into one syntactic category. We also add the following new production to the productions for the initial cwf with $\N$ and $\Pi$-types:
\begin{eqnarray*}
a \in \RawTm &::=&  \Un
\end{eqnarray*}
\subsection{Inference rules} We start with the inference rules for cwfs as in Castellan et al except that they now range over the combined syntactic category $\RawTm$. We also have the usual rules for $\N$ and $\Pi$-types and then add rules expressing that $\Un$ is a universe closed under $\N$ and $\Pi$:
%\begin{figure}
%  \centering
%  \label{fig:cwf4}
%\boxit[Rules for the universe a la Russell]{
  \begin{mathpar}
     	\inferrule
		{\Gamma \vdash} 
		{\Gamma \vdash \Un} 
	\and 
	\inferrule
		{\Gamma \vdash} 
		{\Gamma \vdash \N : \Un}
	\and 
	\inferrule
		{\Gamma \vdash a : \Un
		\and
		\Gamma \cdot a \vdash b : \Un}
		{\Gamma \vdash \Pi(a,b) : \U_{n}}
  \end{mathpar}
We also need 
  \begin{mathpar}
 	\inferrule
		{\Gamma \vdash a = a' : \Un
		\and
		\Gamma \cdot a \vdash b = b': \Un}
		{\Gamma \vdash \Pi(a,b) = \Pi(a',b') : \U_{n}}
  \end{mathpar}
which makes the third rule redundant.

Then there are  rules that each universe $\U_m$ in the tower is an element of all higher universes $\U_n$ for $m < n$:
\begin{mathpar}
     	\inferrule
		{\Gamma \vdash} 
		{\Gamma \vdash \U_m : \U_n}
  \end{mathpar}
 
Remark. It follows that
\begin{mathpar}
    \inferrule
		{\Gamma \vdash a : \Un } 
		{\Gamma \vdash a}
    \and
    \inferrule
		{\Gamma \vdash a : \U_m } 
		{\Gamma \vdash a : \Un}\ m < n
  \end{mathpar}
are admissible rules.
 
\subsection{The initial cwf}

We define the operations in the same way as in the the non-cumulative case, and add the cumulativity operation in $\Ru$
\begin{eqnarray*}
{(\TRu)}_m^{n}(a) &=& a \in \Tm_\Ru(\Gamma,\U_{n})
\end{eqnarray*}
for $a \in \Tm_\Ru(\Gamma,\U_{m})$. We need to check the equations for $(\TRu)_n^{n+1}$ including its commutativity with substitution.

\subsection{The initial cwf-morphism}

Let $\C$ be a cwf with $\Pi, \N$, and a universe tower structure. We now define the initial cwf-morphism on raw terms as in Castellan et al with the following new clauses:
\begin{eqnarray*}
\inte{\Un}_\Gamma &=& {({({\UC})_n})}_{\inte{\Gamma}}\\
\inte{\N}_{\Gamma,\Un} &=&  {({({\NC})^n})}_{\inte{\Gamma},((\UC)_n)_{\inte{\Gamma}}}\\
\inte{\Pi(a,b)}_{\Gamma,\Un} &=& {({({\PiC})^n})}(\inte{a}_{\Gamma,\Un},\inte{b}_{\Gamma \cdot a,\Un})\\
%\inte{\Un}_{\Gamma,\U_{n+1}} &=& {({({\UC})^n})}_{\inte{\Gamma},((\UC)_{n+1})_{\inte{\Gamma}}} \texttt{ (obsolete)}\\
\inte{\U_m}_{\Gamma,\U_{n}} &=& 
(\TC)^n_m{({({\UC})^m})}_{\inte{\Gamma},((\UC)_{n})_{\inte{\Gamma}}}\ (m < n)
%\inte{\U_n}_{\Gamma,\U_{n+1}} &=& {({({\UC})^n})}_{\inte{\Gamma},((\UC)_{n+1})_{\inte{\Gamma}}}
%\inte{\U_m}_{\Gamma,\U_n} &= & (\Ta_\C)^n_m(\inte{a}_{\Gamma,\U_m})
\end{eqnarray*}

We extend the proofs (by induction on derivations) that $\Gamma \vdash A$ implies that $\inte{A}_\Gamma$ is defined and $\Gamma \vdash a : A$ implies that $\inte{a}_{\Gamma,A}$ is defined, and similarly for the equality judgments. 

We need to prove that all operations are preserved by $\inte{-}$. For example, we can prove that 
$$
\inte{(\TRu)_n(a)}_\Gamma = (\TC)_n(\inte{a}_{\Gamma,\U})
$$
for $\Gamma \vdash a : \U$ by induction on the derivation.
% ( $\PiRu$ and $\TRu^{n+1}_n$.)
One of the cases is the rule
$$
\inferrule
		{\Gamma \vdash} 
		{\Gamma \vdash \N : \Un}
$$
we have
$$
\inte{(\Ta_\Ru)_n(\N)}_\Gamma = \inte{\N}_\Gamma = {(\N_\C)}_\Gamma = (\Ta_\C)_n((\NC)^n) = (\Ta_\C)_n(\inte{\N}_{\Gamma,\Un})
$$

\subsection{Uniqueness of the initial cwf-morphism}

We can also extend the uniqueness proof. We assume another cwf-morphism $F : \Ru \to \C$ (preserving all the structure) and prove it equal to $\inte{-} : \Ru \to \C$. As in the proof of Theorem 3.8 in loc.cit, we do induction on the inference rules. We need to prove a few new cases. For example, for the rule
$$
\inferrule
		{\Gamma \vdash} 
		{\Gamma \vdash \N : \Un}
$$
we have
$$
F_{\Gamma,\Un}(\N) =  {({({\NC})^n})}_{F(\Gamma),((\UC)_n)_{F(\Gamma)}} =  {({({\NC})^n})}_{\inte{\Gamma},((\UC)_n)_{\inte{\Gamma}}} = \inte{\N}_{\Gamma,\Un}
$$

\section{Construction of the initial model of a generalized algebraic theory}

\def\Sort{\mathcal{S}}
\def\Op{\mathcal{O}}
\def\Eq{\mathcal{E}}

\subsection{What is a generalized algebraic theory?}

A generalized algebraic theory is specified by a list of sort symbols $\Sort$, operator symbols $\Op$ and equations (between terms) $\Eq$, as follows.

We begin by defining the empty generalized algebraic theory $\Sigma_\emptyset$ as the initial cwf as constructed in Castellan et al. Recall that an initial model is specified by a grammar with productions for raw contexts, raw substitutions, raw types, and raw terms and rules which inductively generate four (families of) partial equivalence relations: $\Gamma = \Gamma' \vdash$ on raw contexts, one on substitutions $\Delta \vdash \gamma = \gamma' : \Gamma$, one on raw types $\Gamma \vdash A = A'$, and one on raw terms $\Gamma \vdash a = a' : A$. 

To begin with all of $\Sort, \Op,$ and $\Eq$ are empty, and the grammars and rules for partial equivalence relations are as in Castellan et al, generating the initial cwf with a category where all objects are terminal, and where there are no types or terms. We then specify how to add a new sort symbol, a new operator symbol, or a new equation. 
\begin{description}
\item[Adding a new sort symbol] 
If $\Gamma \vdash_\Sigma$, then we can introduce a new sort symbol $F$ where its list of arguments have type $\Gamma$. Assume we have built an initial model for $\Sigma$. Then we build the initial model for $\Sigma' = \Sigma + F$ by adding the following production to the grammar 
$$
A ::= F
$$
and rule
\begin{mathpar}
    \inferrule
    {}
    {\Gamma \vdash_{\Sigma'} F}
  \end{mathpar}

\item[Adding a new operator symbol] 
If $\Gamma \vdash_\Sigma A$, then we can introduce a new operator symbol $f$ where its list of arguments have type $\Gamma$ and its result type is $A$. Assume we have built an initial model for $\Sigma$. Then we build the initial model for $\Sigma' = \Sigma + f$ by adding the following production to the grammar 
$$
a ::= f
$$
and rule
\begin{mathpar}
    \inferrule
    {}
    {\Gamma \vdash_{\Sigma'} f : A}
\end{mathpar}

\item[Adding a new equation] 
 If $\Gamma \vdash_\Sigma a, a' : A$, then we can introduce a new equation $a = a'$. Assume we have built an initial model for $\Sigma$. Then we build the initial model for $\Sigma'$ which is $\Sigma$ extended with this equation by adding the rule
 \begin{mathpar}
    \inferrule
    {}
    {\Gamma \vdash_{\Sigma'} a = a' : A}
\end{mathpar}
to the rules in $\Sigma$ that generate equations between terms.
\end{description}

It follows that $\Gamma \vdash_\Sigma$ implies $\Gamma \vdash_{\Sigma'}$, etc.

We would also like to check that sort symbols, operator symbols, and equations can be intermingled. 

\subsection{Cwfs that support a generalized algebraic theory}
Assume that we already know what it means for a cwf $\C$ to support a generalized algebraic theory $\Sigma$, and assume that $\Sigma'$ is the extension with a new sort symbol $\Gamma \vdash_{\Sigma'} F$. Then $\C$ also supports $\Sigma'$ provided there exists $F_{\C} \in \Ty_\C(\inte{\Gamma})$, where $\inte{-}$ is the interpretation morphism from the initial cwf supporting $\Sigma$ to $\C$.

Similarly, if $\Sigma'$ is the extension with a new operator symbol $\Gamma \vdash_{\Sigma'} f : A$. Then a cwf $\C$ that supports $\Sigma'$ is obtained by adding the requirement that there exists $f_\C \in\Tm_\C(\inte{\Gamma},\inte{A}_{\Gamma})$.

Finally, if $\Sigma'$ is the extension with a new equation $\Gamma \vdash_{\Sigma'} a = a': A$. Then a cwf $\C$ that supports $\Sigma'$ is obtained by adding the requirement that $\inte{a}_{\Gamma,A}= \inte{a'}_{\Gamma,A} \in \Tm_\C(\inte{\Gamma},\inte{A}_\Gamma)$.

\subsection{Example: (internal) categories} The generalized algebraic theory of categories has sort symbols Obj and Hom, operator symbols composition and identity, and associativity and identity laws as equations. We say that a cwf that supports this generalized algebraic theory is a cwf with an internal category.

\subsection{Example: (internal) cwfs} Similarly, we can define a cwf that supports the generalized algebraic theory of cwfs. We add sort symbols for types and terms, operator symbols for all the cwf-combinators, and all the cwf-equations. We say that a cwf that supports this generalized algebraic theory is a cwf with an internal cwf.

\subsection{Example: (internal) cwfs with $\Pi$-types} 
We add operator symbols $\Pi, \lambda, \app$ and equations $\beta, \eta$ to the generalized algebraic theory of cwfs. 

\subsection{Example: (internal) cwfs with $\N$-types} 
We add operator symbols $\N, 0, \s, \Rec$ and equations for $\Rec$.

\subsection{Example: (internal) cwfs with $\U_0$ closed under $\Pi$ and $\N$} 
We add operator symbols $\U_0, \Ta_0$, the code operations $\N^0, \Pi^0$, and the decoding equations.

\subsection{Example: (internal) cwfs with universe tower structures} We introduce a new sort symbol for levels and new operator symbols for 0, $\s$, and $\vee$ for levels with the equations for $\vee$. Then we have the other operator symbols and equations for universe tower structures.

Note that we have here extended the notion of cwf with a sort of levels, that is, we are no longer strictly within the framework of (internal) cwfs.

\subsection{Example: (internal) cwfs with universe polymorphic tower structures} Here we need to extend the cwf-framework further to take into account contexts with level variables, etc.
\end{document}