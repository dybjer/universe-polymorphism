\documentclass{lmcs}
%\usepackage{etex}
\usepackage[utf8]{inputenc}

\usepackage{color}
\usepackage{hyperref}
\usepackage{float}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amsthm}
\usepackage{amssymb}
\usepackage{proof}
\usepackage{mathpartir}
\usepackage{mathrsfs}
\usepackage{stmaryrd}
\usepackage{cmll}
\usepackage{enumerate}
\usepackage{graphicx}
\usepackage[all]{xy}
\usepackage{listings}
\usepackage{todonotes}
\usepackage{Guyboxes}
\input{macros}
%\input{newmacros}
\newtheorem{theorem}{Theorem}
\newcommand{\s}{\mathrm{s}}
\newcommand{\Rec}{\mathrm{R}}
\newcommand{\Ta}{\mathrm{T}}
\newcommand{\ta}{\mathrm{t}}
\newcommand{\Ru}{\mathcal{R}}
\newcommand{\Nhat}{\hat{\N}}
\newcommand{\Pihat}{\hat{\Pi}}
\newcommand{\Tan}{\Ta_n}
\newcommand{\Un}{\U_n}
\newcommand{\Nhatn}{\N^n}
\newcommand{\Pihatn}{\Pi^n}
\newcommand{\Nn}{\Nhatn}
\newcommand{\Pin}{\Pihatn}
\newcommand{\TRu}{\Ta_\Ru}
\newcommand{\URu}{\U_\Ru}
\newcommand{\NRu}{\N_\Ru}
\newcommand{\PiRu}{\Pi_\Ru}
\newcommand{\TRun}{{(\Ta_\Ru)}_n}
\newcommand{\URun}{{(\U_\Ru)}_n}
\newcommand{\NRun}{{(\N_\Ru)}^n}
\newcommand{\PiRun}{{(\Pi_\Ru)}^n}
\newcommand{\TRum}{{(\Ta_\Ru)}_m}
\newcommand{\URum}{{(\\U_\Ru)}_m}
\newcommand{\TC}{\Ta_\C}
\newcommand{\UC}{\U_\C}
\newcommand{\NC}{\N_\C}
\newcommand{\PiC}{\Pi_\C}
\newcommand{\Level}{\mathrm{Level}}
\def\Sort{\mathcal{S}}
\def\Op{\mathcal{O}}
\def\Eq{\mathcal{E}}
\def\D{\mathcal{D}}
\def\Cwf{\mathbf{CwF}}
\def\Obj{\mathrm{Obj}}
\def\Ctx{\mathrm{Ctx}}
\def\Hom{\mathrm{Hom}}
\def\id{\mathrm{id}}



\title[Generalized Algebraic Theories and Categories with Families]{A Note on Generalized Algebraic Theories\\and Categories with Families}\author{Marc Bezem, Thierry Coquand, Peter Dybjer, Mart\'in Escard\'o}

\begin{document}

\maketitle

\begin{abstract}
We define a new finitary version of generalized algebraic theories. It differs from Cartmell's original syntactic definition in two respects. Whereas Cartmell allows a possibly infinite set of sort and operator symbols, we only allow a finite number. Moreover, our definition is categorical in the sense that it is based on the notion of initial cwf, and abstract in that it is independent of the particular construction of initial cwfs in terms of syntax and inference rules. 
%This is in the spirit of Voevodsky's "initiality conjecture"\footnote{200731: Maybe we should mention Martin Hofmann already in the abstract, and perhaps remove Voevodsky?} whereby type theories are characterized as initial objects in appropriate categories of models of type theory.  
Our main result is that the category of cwfs supporting a certain signature for gats has an initial object. This result is obtained by extending the construction of an initial cwf from Castellan, Clairambault, and Dybjer. We provide examples of gats for monoids, categories, cwfs, cwfs extended with a first universe, and several different formulations of cwfs with a towers of universes. We also point out that cwfs supporting the gats of monoids, categories, cwfs are cwfs with an internal monoid, category, cwf, respectively.
\end{abstract}

\section{Introduction}

%In this short note we define a notion of finitary generalized algebraic theory in the spirit of Voevodsky's {\em initiality conjecture}.
\footnote{200803: I removed the first sentence referring to the initiality conjecture. 200731: Better to replace this by "initial algebra semantics", which goes back to John Isbell and the ADJ group? Repeat the sentence "Moreover, our definition is categorical in the sense that it is based on the notion of initial cwf, and abstract in that it is independent of the particular construction of initial cwfs in terms of syntax and inference rules". Emphaisze that the definition is quite trivial, but this is a good thing since we get something "canonical": we are writing "the only thing possible". Also think of Mike Shulman as a reader.}

Generalized algebraic theories (gats) were originally introduced by Cartmell in his PhD thesis \cite{cartmell:phd} as a dependently typed generalization of many sorted algebraic theories. Each gat is specified by a signature with (possibly infinite) sets of sort symbols, operator symbols, and equations. Cartmell's definition of gats \cite{cartmell:phd,cartmell:apal} is based on a notion of {\em derived rule} expressed in terms of a traditional syntactic system for dependent type theory. He also defines a notion of model whereby sort symbols are interpreted as families of sets.

We shall here define a new finitary notion of generalized algebraic theory and simultaneosly a general categorical notion of model. Our definition is based on categories with families (cwfs) \cite{dybjer:torino}. We simultaneously define what it means to be a valid signature $\Sigma$ for a gat and the category $\Cwf_\Sigma$ of cwfs supporting $\Sigma$. This definition refers to the construction of initial objects in $\Cwf_\Sigma$ but is independent of the details of this construction. Afterwards, we show that the initial object of $\Cwf_\Sigma$ exists for all valid $\Sigma$ by extending Castellan, Clairambault, and Dybjer's  construction of the initial object of the category $\Cwf$ of cwfs \cite{castellan:tlca2015,castellan:lmcs}.

\footnote{200803: I also removed the following about the initiality conjecture: "Voevodsky's initiality conjecture \cite{voevodsky:initiality} aims to characterize a whole class of type theories abstractly as initial objects in suitable categories of models and to prove that these initial objects exist. By abstracting from the precise details of syntax and inference rules for a particular type theory, one aims to develop a more general, elegant, semantic, rigorous, and formalizable metatheory of type theory. (I just read  \cite{voevodsky:initiality} and feel that this paragraph is too much my own interpretation of the initiality conjecture.)

For example, we can define Martin-LÃ¶f type theory as the initial object in the category of categories with families (cwfs) with extra structure for interpreting the type formers. An explicit construction of this initial object has been carried out by Castellan, Clairambault, and Dybjer \cite{castellan:tlca2015,castellan:lmcs}. "}

\footnote{
Mention contextual category and Cartmell's equivalence between the categories of gats and of contextual categories. 
}
\footnote
{Mention Martin Hofmann's notion of category with attributes (cwa) and its relation to contextual categories. Also remark that Cartmell used the name cwa for a slightly different notion. Mention cwfs and Martin Hofmann's paper on "Syntax and Semantics of Dependent Types" which is based on cwfs. (Maybe one could actually elaborate this to a survey of Martin's contributions to the semantics of dependent type theory.) We could motivate this note by saying that it could be added to "Syntax and Semantics of Dependent Types" as yet another basic result for dependent type theory.
}
\footnote
{Refer to Streicher and Brunerie for related work.}
\footnote
{Point out that the point of cwfs is that it is a gat, but that gats are defined in terms of cwfs, so cwfs appear both on the meta-level, and on the object level as an example of a gat.}
\footnote
{Mention the typical phenomenon in category that you define something first and only later show that it exists.}
\footnote
{Mention the connection with QIITs of Altenkirch and Kaprosi. We provide set-theoretic semantics for a class of QIITs, those generated by valid signatures in our sense. It remains to explain how such semantics can be integrated in the full set-theoretic semantics of type theory. Also check how Altenkirch and Kaprosi's QIITs deal with intensional vs definitional equality. They don't have definitional quotients.}

\section{Categories with families}\label{sec:def_cwf}

\subsection{The category of cwfs and strict cwf-morphisms}

In this section (whole paper?), the meta-language is set-theoretic.
Much of the vocabulary is category-theoretic, but we freely use
equality of objects in a categorical context.
We first define the category $\Fam$, and then the category $\Cwf$.

\begin{definition}\label{def:catFam}
$\Fam$ is a category whose objects are
set-indexed families of sets, denoted as $(U_x)_{x\in X}$.
A morphism of $\Fam$ with source $(U_x)_{x\in X}$ and target $(V_y)_{y\in Y}$
consists of a re-indexing function $f: X\to Y$ together with a family
$(g_x)_{x\in X}$ of functions $g_x : U_x \to V_{f(x)}$. %, for all $x\in X$.
\end{definition}

The next step is to define the category $\Cwf$. 
We split this definition in two: first the objects, 
which are called \emph{categories with families}, in Definition~\ref{def:Cwfobj},
and then the morphisms in Definition~\ref{def:Cwfmor}. 
Since $\Cwf$ has been developed as a categorical framework for the semantics of
type theory, much of the terminology (contexts, substitutions,
types, terms) refers to the syntax of type theory, 
suggesting the intended interpretation of this syntax in the 
so-called $\Cwf$-semantics.

The main novelty of this note is to use $\Cwf$ as a framework
to define a new notion of a generalised algebraic theory. 
Contexts, substitutions and terms also make
sense in relation to gat's. Perhaps it would have been natural
to replace the phrase `type' by `sort' (ref to Makkai, FOLDS?),
but we have chosen to stick to existing terminology.
It is important to stress, however, that the definition
of the notion of a generalised algebraic theory in this note
is not a syntactical one. 

\begin{definition}\label{def:Cwfobj} 
A category with families (cwf) consists of the following data:

\begin{enumerate} 

\item A category $\C$; 

\item A $\Fam$-valued presheaf on $\C$, that is, a functor
$T : \Cop \to \Fam$;

\item A terminal object $1\in \C$, and unique maps
$\tuple{}_\Gamma \in \C(\Gamma, 1)$ for all objects $\Gamma$ of $\C$;

\item Operations ${\cext\,},~\tuple{\_,\_},~\p$ and $\q$ 
explained in the following paragraphs.
These four operations and their associated equations
are referred to as \emph{context comprehension}.
\end{enumerate}

We let $\Gamma, \Delta,\ldots$ range over objects of $\C$, 
and refer to them as \emph{contexts}. 
We let $\delta, \gamma,\ldots$ range over morphisms, 
and refer to them as \emph{substitutions}. 
We refer to $1$ as the \emph{empty} context; the terminal maps
$\tuple{}_\Gamma$ represent the \emph{empty} substitutions.

If $T(\Gamma) = (U_x)_{x\in X}$, we write $\Ty(\Gamma)$ for the set $X$.
We call the elements of $\Ty(\Gamma)$ \emph{types in context $\Gamma$}, 
and let $A, B, C$ range over such types. 
Furthermore, for $A \in \Ty(\Gamma)$, we write $\Tm(\Gamma, A)$ for the set $U_A$
and call the elements of $\Tm(\Gamma, A)$ 
\emph{terms of type $A$ in context $\Gamma$}. 

For $\gamma : \Delta \to \Gamma$,
the functorial action of $T$ yields a morphism
\[
T(\gamma) \in  \Fam\left((\Tm(\Gamma, A))_{A\in \Ty(\Gamma)}, % \to 
                (\Tm(\Delta, B))_{B\in \Ty(\Delta)}\right)
\]
consisting of a reindexing function $\_\,[\gamma] : \Ty(\Gamma) \to
\Ty(\Delta)$ referred to as \emph{substitution in types}, and for each $A\in
\Ty(\Gamma)$ a function $\_\,[\gamma] : \Tm(\Gamma, A) \to \Tm(\Delta,
A[\gamma])$, referred to as \emph{substitution in terms}.

Now we turn to the explanation of the operations 
${\cext\,},~\tuple{\_,\_},~\p,~\q$.
Given $\Gamma \in \C$, $A \in \Ty(\Gamma)$, $\gamma : \Delta \to \Gamma$,
and $a\in \Tm(\Delta, A[\gamma])$, we have
\[
\Gamma \cext A \in \C
\quad\qquad
\p_{\Gamma, A} : \Gamma \cext A \to \Gamma
\quad\qquad
\q_{\Gamma, A} \in \Tm(\Gamma\cext A, A[\p_{\Gamma,A}])
\quad\qquad
\tuple{\gamma, a} : \Delta \to \Gamma \cext A.
\] 
We call $\Gamma \cext A$ the \emph{extended} context 
and $\tuple{\gamma, a}$ the \emph{extended} substitution.

The operations  ${\cext\,},~\tuple{\_,\_},~\p,~\q$
satisfy the following universal property:
$\tuple{\gamma, a}$ is the unique substitution satisfying
\[
\p_{\Gamma, A} \circ \tuple{\gamma, a} = \gamma
\qquad \text{and}\qquad
\q_{\Gamma, A} [\tuple{\gamma, a}] = a\,.
\]
We refer (colloquially) to $\p$ as the \emph{first projection},
and to $\q$ as the \emph{second projection}. %\footnote%
{Note that the first equation implies that
$\Tm(\Delta,A[\p_{\Gamma,A}][\tuple{\gamma, a}]) = \Tm(\Delta,A[\gamma])$
so that $\q_{\Gamma, A} [\tuple{\gamma, a}]$ and $a$ are elements of the same set.}
(End Definition~\ref{def:Cwfobj}.)
\end{definition}



A cwf is thus a structure $(\C,1,\tuple{},T,\cext\, , \tuple{\_,\_},\p, \q)$, 
subject to equations, for the category and the presheaf, and universal
properties for the terminal object and for context comprehension. 
The morphisms to be defined next preserve this structure,
even in a strict way (`on the nose').
We often shorten the notation of a cwf to $(\C,T)$, leaving the remaining
structure implicit.

\begin{definition}\label{def:Cwfmor}  
A \emph{(strict) cwf-morphism $F$ between cwfs $(\C,T_\C)$ and $(\D,T_\D)$}
consists of

\begin{enumerate}

\item A functor $F_{cat} : \C \to \D$, preserving $1$ on the nose,
that is, $F_{cat}(1_{\C}) = 1_{\D}$;

\item A natural transformation $F_{nat} : T_\C \Rightarrow (T_\D \circ F_{cat})$,
preserving context comprehension on the nose (explained below).

\end{enumerate}
 
As $F_{nat}$ is a natural transformation between $\Fam$-valued presheaves,
$F_{nat}$ has a component for any object $\Gamma$ of $\C$, and
these components are morphisms in $\Fam(T_C(\Gamma),T_\D(F_{cat}(\Gamma)))$.
Recall that morphisms in $\Fam$ consist of a reindexing function
and a family of functions. It is convenient to denote $F_{cat}$,
all reindexing functions, as well as all members of the families of functions,
simply by $F$. Thus we have $F(A) \in \Ty_\D(F(\Gamma))$ 
and $F(a) \in \Tm_\D(F(\Gamma), F(A))$, for all $\Gamma$
and $A\in\Ty_\C(\Gamma)$ and $a\in \Tm_\C(\Gamma, A)$.

Naturality of $F_{nat}$
amounts to preservation of substitution, {i.e.}, for all 
$\gamma : \Delta \to \Gamma$ in $\C$, we have
\[
F(A[\gamma]) = F(A)[F(\gamma)] \qquad \qquad 
F(a[\gamma]) = F(a)[F\gamma]\,.
\]

Last but not least, we turn to the preservation of context comprehension
on the nose, and require
\[ 
F(\Gamma\cext A) = F(\Gamma)\cext F(A) \qquad
%F(\tuple{\gamma,a}) = \tuple{F(\gamma),F(a)} \qquad
F(\p_{\Gamma, A}) = \p_{F(\Gamma), F(A)} \qquad
F(\q_{\Gamma, A}) = \q_{F(\Gamma), F(A)}\,.
\]

Note that the universal property implies that also
$F(\tuple{\gamma,a}) = \tuple{F(\gamma),F(a)}$.
The same is true for the terminal maps:
$F(\tuple{}_\Gamma) = \tuple{}_{F(\Gamma)}$.
(End Definition~\ref{def:Cwfmor}.)
\end{definition}

Small cwfs with strict cwfs-morphisms form a category, written $\Cwf$. 

\footnote{200805: The following is removed for the time being. Some of it should probably be moved to the introduction of section 5:
"One of the main features of cwfs is that they are models of a certain generalized algebraic theory which arises naturally by unfolding the definition above. Moreover, this gat bears a close resemblance to Martin-LÃ¶f's substitution calculus. However a main difference is that Martin-LÃ¶f's calculus uses ordinary named variables whereas the gat for cwfs uses a combinator language quite similar to the ccc-combinators that arise from the definition of cartesian closed categories. Another main difference is that a gat is not a usual formal system defined in terms of a raw syntax and inference rules. Instead it is a dependently typed generalization of many sorted algebras. The formalism assumes a basic framework for dependent type theory. In this language you specify a {\em signature} consisting of a list of sort symbols and operator symbols, with dependent typings, and equations (between terms). (Cartmell \cite{cartmell:phd,cartmell:apal} also allows equations between sort terms, but most examples do not make use of such. It would be straightforward to include such equations in our account too.) 

We shall now display the sort symbols, operator symbols, and equations of the gat of cwfs. Note that the four sort symbols $\Ctx, \Hom, \Ty,$ and $\Tm$ correspond to the respective four of the judgment forms of Martin-LÃ¶f's substitution calculus:
\begin{eqnarray*}
\\&&\Gamma \vdash
\\&&\Delta \vdash \gamma : \Gamma
\\&&\Gamma \vdash A
\\&&\Gamma \vdash a : A
\end{eqnarray*}
In addition to these the substitution calculus have the following forms of equality judgments:
\begin{eqnarray*}
\\&&\Gamma = \Gamma' \vdash
\\&&\Delta \vdash \gamma = \gamma' : \Gamma
\\&&\Gamma \vdash A = A'
\\&&\Gamma \vdash a = a' : A
\end{eqnarray*}
Furthermore, the operator symbols correspond to syntactic constructions of contexts, substitutions, types, and terms, with their typing rules. Finally, the equations correspond to certain equality rules, expressed in terms of the equality judgments. 

We will now specify the sort symbols, operators symbols and equations of the gat of cwfs in traditional notation with variables. Here we assume that the reader is familiar with dependent type theory to get an informal understanding of what a gat is. Note that mutual dependence of the notions of gat and cwf. Here we define cwfs as a gat and in the next section we will define valid signatures and models of gats in terms of initial cwfs. Note also that the official metalanguage of this article is set theory, and that definition X should be understood in set-theoretic metalanguage.

We shall give the signature of the cwf of gats stepwise: first the signature for categories, then we extend it with a family-valued functor, then with a terminal object, and finally with context comprehension.
}



\subsection{The initial cwf}

\begin{theorem}
(Castellan, Clairambault, and Dybjer \cite{castellan:tlca2015,castellan:lmcs}) The category $\Cwf$ has an initial object $\T$.
\end{theorem}

%We only sketch the construction of $\T$ and refer to \cite{castellan:tlca2015,castellan:lmcs} for details.

We only sketch the construction of $\T$. It is defined in three steps:
\begin{itemize}
\item 
First we define grammars for raw contexts, raw substitutions, raw types, and raw terms.
\begin{eqnarray*}
\Gamma \in \RawCtx &::=& 1  \ |\ \Gamma\cext A\\
\gamma \in \RawSub \ &::=& \gamma \circ \gamma \ |\ \id_\Gamma \ |\ \langle\rangle_\Gamma \ |\ \p_{A} \ |\ \langle \gamma, a \rangle_A\\
A \in \RawTy &::=& o \ |\  A[\gamma]\\
a \in \RawTm &::=& a[\gamma] \ |\ \qI_A
\end{eqnarray*}
\item
Then we define the well-formed contexts and types, and the well-typed
substitutions and terms. In Martin-L\"of's substitution calculus these are defined by a system of inference rules for all the eight forms of judgments. Here we choose a more economical way, by only defining well-formed \emph{equal} contexts and types, and the well-typed \emph{equal} substitutions and terms. Thus we define four families of partial equivalence relations (pers), corresponding to the four forms of equality judgments, by a mutual inductive definition:
$$
\Gamma = \Gamma' \vdash
\qquad
\Gamma \vdash A = A' 
\qquad
\Delta \vdash \gamma = \gamma' : \Gamma
\qquad
\Gamma \vdash a = a' : A
$$
where $\Gamma, \Gamma' \in \RawCtx, \gamma, \gamma' \in \RawSub, A, A' \in \RawTy,$ and $a,a' \in \RawTm$. The basic judgment forms can then be defined as the reflexive instances of the pers:
\begin{itemize}
\item 
$\Gamma \vdash$ abbreviates $\Gamma = \Gamma \vdash$, 
\item
$\Gamma \vdash A$ abbreviates $\Gamma \vdash A = A$,
\item
$\Delta \vdash \gamma : \Gamma$ abbreviates  $\Delta \vdash \gamma = \gamma : \Gamma$, 
\item
$\Gamma \vdash a : A$ abbreviates $\Gamma \vdash a = a : A$.
\end{itemize}
\item
The initial cwf $\T$ is then constructed from the equivalence classes of derivable judgments. For example, the contexts in $\T$ are equivalence classes $[\Gamma]$, such that $\Gamma \vdash$. To prove that $\T$ is initial we construct a cwf-morphism $\inte{-} : \T \to \C$ to an arbitrary cwf $\C$. This morphism is a partial function mapping raw contexts to contexts in $\C$, raw substitutions to substitutions in $\C$, raw types to types in $\C$, and raw terms to terms in $\C$. Then we show that these partial functions preserve the partial equivalence relations so that we can define the interpretation morphism on the equivalence classes, and also show that it is indeed a cwf-morphism.
\end{itemize}
We refer to Castellan, Clairambault, and Dybjer \cite{castellan:tlca2015,castellan:lmcs} both for the list of inference rules for the partial equivalence relations and for the details of the initiality proof.


Note that the initial cwf $\T$ is rather uninteresting: its category of contexts contains only a terminal object (the empty context), and there are no types and terms. Nevertheless, the syntax and inference rules used in its definition form the starting point both for the formulation of Martin-LÃ¶f type theory as initial cwfs supporting type formers such as $\Pi, \Sigma, \N$, etc, and for our notion of generalized algebraic theory as the initial object $\T_\Sigma$ in the category $\Cwf_\Sigma$ of cwfs supporting a valid signature $\Sigma$.

\section{Signatures and models of generalized algebraic theories}

We now come to the main point of this note. We define how to build a valid gat signature $\Sigma$ and what it means for a cwf to support it. This definition relies on the construction of initial cwfs $\T_\Sigma$ supporting $\Sigma$, but we will postpone the construction of these until the next section. In this way we separate the abstract definition from the concrete syntactic details employed for building $\T_\Sigma$. 
\footnote{Say something about the fact that we do not assume anything about the relationship between $\T_\Sigma$ and $\T_{\Sigma'}$ because all initial objects are isomorphic, and hence we can move between them.}
\begin{definition}
We define inductively how to build a valid signature $\Sigma$ and the category $\Cwf_\Sigma$ of cwfs that support $\Sigma$ and cwf-morphisms that preserve it. First, the base case:
\begin{description}
\item[The empty signature] The empty signature $\emptyset$ is valid and $\Cwf_\emptyset = \Cwf$. 
\end{description}
Assume now that $\Sigma$ is a valid signature and that the category $\Cwf_\Sigma$ has an initial object $\T_\Sigma$ with $\inte{-} : \T_\Sigma \to \C$ as the unique morphism into an object $\C$. Then we can add a new type symbol, or a new operator symbol, or a new equation, to get a new valid signature, as follows:
\begin{description}
\item[Adding a new sort symbol] 
If $\Gamma$ is a context in $\T_\Sigma$, then we can extend $\Sigma$ with a new sort symbol $F$ (with context $\Gamma$) to obtain an extended gat $\Sigma'$. A cwf $\C$ supports $\Sigma'$ if it supports $\Sigma$ and there is $F_\C \in \Ty_\C(\inte{\Gamma})$. A cwf-morphism in $\C \to \D$ preserves $\Sigma'$ if it preserves $\Sigma$ and maps $F_\C$ to $F_\D$.
\item[Adding a new operator symbol] 
If $\Gamma$ is a context in $\T_\Sigma$ and $A \in \Ty_{\T_\Sigma}(\Gamma)$, then we can extend $\Sigma$ with a new operator symbol $f$ (with context $\Gamma$ and type $A$). A cwf $\C$ supports $\Sigma'$ if it supports $\Sigma$ and there is $f_\C \in\Tm_\C(\inte{\Gamma},\inte{A}_{\Gamma})$.
A cwf-morphism in $\C \to \D$ preserves $\Sigma'$ if it preserves $\Sigma$ and maps $f_\C$ to $f_\D$.
\item[Adding a new equation] 
If $\Gamma$ is a context in $\T_\Sigma$, $A \in \Ty_{\T_\Sigma}(\Gamma)$, and $a, a' \in \Tm_{\T_\Sigma}(\Gamma,A)$, then we can extend $\Sigma$ with a new equation $a = a'$ (with context $\Gamma$ and type $A$). A cwf $\C$ supports $\Sigma'$ if it supports $\Sigma$ and $\inte{a}_{\Gamma,A}= \inte{a'}_{\Gamma,A} \in \Tm_\C(\inte{\Gamma},\inte{A}_\Gamma)$. A cwf-morphism in $\C \to \D$, where $\C$ and $\D$ support $\Sigma'$, preserves $\Sigma'$ iff it preserves $\Sigma$.
\end{description}
\end{definition}

Note that the empty signature $\emptyset$ is the only valid signature that can be directly constructed from the definition. In order to form other signatures we need to construct initial cwfs supporting already constructed signatures. This is the topic of the next section.

\section{All signatures have initial cwfs supporting them}

We shall now show our main theorem. It can be viewed as a generalization of Birkhoff's completeness theorem for equational logic \cite{birkhoff}:
\begin{theorem}
The category $\Cwf_\Sigma$ has an initial object $\T_\Sigma$ for every valid signature $\Sigma$.
\end{theorem}

The proof is by induction on the construction of $\Sigma$.
\begin{description}
\item[The empty signature] 
The category $\Cwf = \Cwf_\emptyset$ of cwfs and strict cwf-morphisms has an initial object $\T_\emptyset$ \cite{castellan:tlca2015,castellan:lmcs}.
\end{description}

Assume we have specified grammars and inference rules for $\T_\Sigma$ and that we write $\vdash_\Sigma$ for derivability by these inference rules. Let $\Sigma'$ be $\Sigma$ extended by a new sort symbol, a new operator symbol, or a new equation. We shall now explain how to build $\T_{\Sigma'}$, to extend the grammars and inference rules for $\T_\Sigma$.
\begin{description}
\item[Adding a new sort symbol] 
If $\Gamma$ is a context in $\T_\Sigma$ and $\Sigma'$ is $\Sigma$ extended with a new sort symbol $F$ (with context $\Gamma$). Then $\T_{\Sigma'}$ is defined by adding the production
$$
A ::= F
$$
to the grammar for raw types, and the inference rule
\begin{mathpar}
    \inferrule
    {}
    {\Gamma \vdash_{\Sigma'} F}
  \end{mathpar}
to the inference rules for $\Sigma$.

We then define $F_{\T_{\Sigma'}} = [F]$. It follows that $ \T_{\Sigma'}$ supports $\Sigma'$. 

Moreover, we extend the definition of the interpretation morphism $\inte{-}$  to an interpretation morphism $\inte{-}' : \T_{\Sigma'} \to \C$ by 
$$
\inte{[F]}' = F_\C
$$
It follows immediately that this is a morphism in $\Cwf_{\Sigma'}$ and that it is unique.

\item[Adding a new operator symbol] 
If $\Gamma$ is a context in $\T_\Sigma$ and $A \in \Ty_{\T_\Sigma}(\Gamma)$ and $\Sigma'$ is $\Sigma$ extended with a new operator symbol $f$ (with context $\Gamma$ and type $A$). Then $\T_{\Sigma'}$ is defined by adding the production
$$
a ::= f
$$
to the grammar for raw terms, and the inference rule
\begin{mathpar}
    \inferrule
    {}
    {\Gamma \vdash_{\Sigma'} f : A}
\end{mathpar}
to the inference rules for $\Sigma$.

We then define $f_{\T_{\Sigma'}} = [f]$ and extend the definition of the interpretation morphism $\inte{-}$  to an interpretation morphism $\inte{-}' : \T_{\Sigma'} \to \C$ by 
$$
\inte{[f]}' = f_\C
$$
It follows immediately that this is a morphism in $\Cwf_{\Sigma'}$ and that it is unique.

\item[Adding a new equation] 
If $\Gamma$ is a context in $\T_\Sigma$ and $A \in \Ty_{\T_\Sigma}(\Gamma)$ and $a, a' \in \Tm_{\T_\Sigma}(\Gamma,A)$, and $\Sigma'$ is $\Sigma$ extended with a new equation $a = a'$ (with context $\Gamma$ and type $A$). Then $\T_{\Sigma'}$ is defined by adding the inference rule
 \begin{mathpar}
    \inferrule
    {}
    {\Gamma \vdash_{\Sigma'} a = a' : A}
\end{mathpar}
to the inference rules for $\Sigma$.

It is immediate that $\T_{\Sigma'}$ supports $\Sigma'$. In order to define the
interpretation morphism $\inte{-}'$, recall that the interpretation morphism $\inte{-} : \T_\Sigma \to \C$ is defined in two steps. The first step is to define a partial function mapping raw contexts to objects of $\C$, raw substitutions to morphisms of $\C$, raw types to types of $\C$, and raw terms to terms of $\C$. The second step is to prove that this partial function preserves the partial equivalence relation and define $\inte{-}$ on the equivalence classes. In order to define $\inte{-}'$ we first define the partial function on the raw syntax to be identical to the partial function on the raw syntax for $\inte{-}$. (The raw syntax for $\T_{\Sigma'}$ is the same as the one for $\T_\Sigma$.) We then prove that this partial function preserves the extended partial equivalence relation and define $\inte{-}'$ on the new equivalence classes. It follows that $\inte{-}'$ is unique.\end{description}

\section{Examples of generalized algebraic theories}

\subsection{Monoids} The one sorted algebraic theory of monoids has two operator symbols  $\id$ for identity and $\circ$ for composition, and associativity and identity laws as equations. As every other algebraic theory in the ordinary sense the algebraic theory of monoids yields a generalized algebraic theory. We first introduce one constant sort symbol $M$, and then the operator symbols $\id$ for identity and $\circ$ for composition, and the associativity and identity laws as equations. 

A cwf $\C$ that supports this gat is an {\em internal monoid} in $\C$. Ordinary (small) monoids come out as internal monoids in $\Set$, the category of small sets.

\subsection{Categories} We begin with the gat of categories, one of Cartmell's motivating examples. We first show it in ordinary notation with variables. Then we show how to generate a valid signature for the gat of categories using the combinator language used for constructing initial cwfs $\T_\Sigma$ as explained in section \ref{}.

Sort symbols:
\begin{eqnarray*}
&\vdash& \Ctx\\
\Delta, \Gamma : \Ctx &\vdash& \Hom(\Delta,\Gamma)\\
\end{eqnarray*}

Operator symbols:
\begin{eqnarray*}
\Gamma : \Ctx &\vdash& \id_\Gamma : \Hom(\Gamma,\Gamma)\\
\Xi,\Delta,\Gamma : \Ctx, \gamma : \Hom(\Delta,\Gamma), \delta : \Hom(\Xi,\Delta) &\vdash&
\gamma \circ \delta : \Hom(\Xi,\Gamma)
\end{eqnarray*}

Equations:
\begin{eqnarray*}
\Delta, \Gamma : \Ctx, \gamma : \Hom(\Delta,\Gamma) &\vdash& \id_\Gamma \circ \gamma = \gamma : \Hom(\Delta,\Gamma)\\
\Delta, \Gamma : \Ctx, \gamma : \Hom(\Delta,\Gamma) &\vdash& \gamma \circ \id_\Delta = \gamma : \Hom(\Delta,\Gamma)\\
\Theta, \Xi,\Delta,\Gamma : \Ctx, \gamma : \Hom(\Delta,\Gamma), \delta : \Hom(\Xi,\Delta), \xi : \Hom(\Theta,\Xi) &\vdash&
(\gamma \circ \delta) \circ \xi = \gamma \circ (\delta \circ \xi): \Hom(\Theta,\Gamma)
\end{eqnarray*}

We make a few remarks. $\Ctx = \Obj$ is the constant sort of objects of the category of contexts in a cwf. $\Hom$ is a binary sort symbol for the context morphisms in the cwf. The typing of the two arguments is represented by the context $\Delta, \Gamma : \Ctx$. 
%In order to build $\Hom(\Delta,\Gamma)$ for two concrete contexts $\vdash \Delta : \Ctx$ and $\vdash \Gamma : \Ctx$ we need to apply $\Hom$ to the context morphism consisting of $\Delta$ and $\Gamma$ to yield $\Hom(\Delta,\Gamma)$. (There is more to say ...)
Moreover, composition is officially an operator symbols with five arguments. In the official notation we should write $\gamma \circ_{\Xi,\Delta,\Gamma} \delta$, but we suppress the context arguments $\Xi,\Delta,\Gamma$. We will do so for some other operations too.

\subsubsection{How to generate the valid signature using the combinator language} 
The signature for the generalized algebraic theory of categories has sort symbols $\Obj$ 
and $\Hom$, operator symbols $\id$ for identity and $\circ$ for composition, and associativity and identity laws as equations. We shall here sketch how to generate the valid signature for categories with reference to definition \ref{} and using cwf-combinators.
\begin{itemize}
\item The initial cwf $\T_\emptyset$ (as constructed above) has only one object (context) [1], one equivalence class of morphisms $[\id_1]$ (with several representatives: $\tuple{}_1, \id_1 \circ \id_1$, etc), and no types and terms. Hence we can add a new constant sort $\Obj$ of (internal) objects with context $1$ to the signature. 
\item $\T_{([\Obj],[],[])}$ (as constructed above) contains the context $[(1.\Obj).\Obj[\p_{1,\Obj}]]$ (corresponding to the context $x : \Obj, y : \Obj$ in usual notation). Hence we can introduce a new sort $\Hom$ with this context. This sort represents the family $\Hom(x,y)$ of (internal) morphisms.
\item $\T_{([\Obj, \Hom],[],[])}$ contains the context $[1.\Obj]$ (corresponding to the context $x : \Obj$) and the type $[\Hom[\tuple{\id_{1.\Obj},\q_{1,\Obj}}]]$ (corresponding to the type $\Hom(x,x)$). Hence we can introduce an operator symbol $\id$ with this context and type.
\item In a similar way we can add the operator symbol for composition and the equations, but we omit the details.
\end{itemize}

\subsection{Cwfs}

The gat of cwf is obtained by extending the gat of categories with new sort symbols, operator symbols, and equations for a family valued functor, and then new operator symbols and equations for a terminal object, and context comprehension.

\subsubsection{The extension with a family valued functor}

\subsubsection{The extension with a terminal object}
The universal property of the terminal object can be expressed by 
a simple equation. (This is not true for the universal property of
context comprehension, as that would require a conditional equation.) 

Operator symbols:
\begin{eqnarray*}
&\vdash& 1 : \Ctx\\
\Gamma : \Ctx &\vdash& \tuple{}_\Gamma : \Hom(\Gamma,1)
\end{eqnarray*}

Equation:
\begin{eqnarray*}
\Gamma : \Ctx, \gamma : \Hom(\Gamma,1) &\vdash& \gamma = \tuple{}_\Gamma : \Hom(\Gamma,1)
\end{eqnarray*}


\subsubsection{The extension with context comprehension}

We say that a cwf that supports the generalized algebraic theory of categories is a cwf with an {\em internal category}. This is a cwf-based analogue of the usual notion of internal category in a category with finite limits. As shown by Martin Hofmann's \cite{hofmann:csl,hofmann:cambridge}, every category with finite limits yields a category with attributes, and hence a cwf. However, not every cwf has finite limits; we need more structure.  Clairambault and Dybjer \cite{ClairambaultD11,ClairambaultD14} proved that the 2-category of finite limits is biequivalent to the 2-category of democratic cwfs that support $\Sigma$-types and extensional identity types.

\subsection{Cwfs} Similarly, we can define a cwf that supports the generalized algebraic theory of cwfs. We add sort symbols for types and terms, operator symbols for all the cwf-combinators, and all the cwf-equations. We say that a cwf that supports this generalized algebraic theory is a cwf with an {\em internal cwf}.

The signature for the gat of cwfs was already displayed in \ref{}. We leave it to the reader to verify that it can be formulated as a valid signature using cwf-combinators too.

\subsection{Cwfs with $\Pi$-types} 
We add operator symbols $\Pi, \lambda, \app$ and equations $\beta, \eta$ to the generalized algebraic theory of cwfs. 

\subsection{Cwfs with $\N$-types} 
We add operator symbols $\N, 0, \s, \Rec$ and equations for $\Rec$.

\subsection{Cwfs with $\U_0$ closed under $\Pi$ and $\N$} 
We add operator symbols
\begin{eqnarray*}
\Gamma : \Ctx &\vdash& (\U_0)_\Gamma : \Ty(\Gamma)\\
\Gamma : \Ctx, a : \Tm(\Gamma,(\U_0)_\Gamma) &\vdash& {\Ta_0}(a) : \Ty(\Gamma)\\
\Gamma : \Ctx &\vdash& (\N^0)_\Gamma : \Tm(\Gamma,(\U_0)_\Gamma) \\
\Gamma : \Ctx, 
a : \Tm(\Gamma,(\U_0)_\Gamma), 
b :  \Tm(\Gamma \cdot \Ta_0(a), (\U_0)_\Gamma))
&\vdash&
 \Pi^0(a,b) : \Tm(\Gamma,(\U_0)_\Gamma)
\end{eqnarray*}
$(\U_0)_\Gamma$ is the first universe (a type) relative to the context $\Gamma$; $\Ta_0$ is the decoding operation mapping a term in the first universe to the corresponding type; \footnote{add discussion of sort vs type in the introduction}; $\N^0$ is the code for $\N$ in the first universe, and $\Pi^0$ forms codes for $\Pi$-types in the first universe. (Note that we have dropped the context argument of $\Ta_0$ and $\Pi^0$.)

We add the decoding equations:
\begin{eqnarray*}
\Ta_0(\N^0_\Gamma) &=& \N_\Gamma\\
\Ta_0(\Pi^0(a,b)) &=& \Pi(\Ta_0(a),\Ta_0(b))
\end{eqnarray*}
and the equations for preservation of substitution:
\begin{eqnarray*}
{(\U_0)}_\Gamma [ \gamma ] &=& {(\U_0)}_\Delta\\
\Ta_0(a) [ \gamma ] &=& \Ta_0(a[ \gamma ] )\\
\N^0_\Gamma [ \gamma ] &=&\N^0_\Delta\\
\Pi^0(a,b)[ \gamma ] &=& \Pi^0(a [ \gamma ], b[ \gamma^+ ])
\end{eqnarray*}
where $\gamma^+ = \tuple{\gamma \circ \p, \q}$.

We remark that the gat for the first universe is inevitably "a la Tarski" in the sense that we distinguish between types and terms in a cwf and we must have an operation decoding a term into a type. However, the terminology "a la Russell" vs "a la Tarski" in Martin-LÃ¶f's sense refers to two different formalizations of the raw syntax and inference rules of type theory. The a la Tarski formulation is the one which arises most directly by turning the gat signature into its initial cwf. However, we can prove that the a la Russell formulation also gives rise to an initial cwf for the same signature. It follows that a la Tarski and a la Russell give rise to isomorphic cwfs that support a first universe.

\subsection{Cwfs with universe tower structures} 

The first formulation of intuitionistic type theory with an infinite sequence of universes is due to Martin-LÃ¶f
\cite{martinlof:predicative}. Rules for cumulativity (or lifting) were added in Martin-LÃ¶f \cite{martinlof:hannover}. Both formulations have an infinite sequence of universes indexed by external natural numbers, and as a consequence the theories have infinitely many rules. 

We shall now formalize a notion of finitary gat closely related to Martin-LÃ¶f's cumulative version. The external natural number indices will be represented by internal level indices in the gat. To this end we introduce a new sort symbol 
$$
\vdash \Level
$$
in addition to the previous four sort symbols. (However, we do not have a {\em type} of levels.) An element $n : \Level$ represent an external natural number. (Note that the new sort $\Level$ corresponds to adding a new form of judgment $\vdash n\  \Level$ to the formal system.)

We add operator symbols for levels
\begin{eqnarray*}
&\vdash& 0 : \Level\\
n : \Level &\vdash& \s(n) : \Level
\end{eqnarray*}
and operator symbols for types and terms:
\begin{eqnarray*}
n : \Level, \Gamma : \Ctx &\vdash& (\U_n)_\Gamma : \Ty(\Gamma)\\
n : \Level, \Gamma : \Ctx, a : \Tm(\Gamma,(\U_n)_\Gamma) &\vdash& {\Ta_n}(a) : \Ty(\Gamma)\\
n : \Level, \Gamma : \Ctx &\vdash& (\N^n)_\Gamma : \Tm(\Gamma,(\U_n)_\Gamma) \\
n : \Level, \Gamma : \Ctx, 
a : \Tm(\Gamma,(\U_n)_\Gamma), 
b :  \Tm(\Gamma \cdot \Ta_n(a), (\U_n)_\Gamma))
&\vdash&
 \Pi^n(a,b) : \Tm(\Gamma,(\U_n)_\Gamma)\\
n : \Level, \Gamma : \Ctx &\vdash& (\U^n)_\Gamma \in \Tm(\Gamma,(\U_{\s(n)})_\Gamma)\\
n : \Level, \Gamma : \Ctx, a : \Tm(\Gamma,(\U_n)_\Gamma) &\vdash& \Ta_n^{n+1}(a)\footnote{200804: should we change notation $\Ta_n^{n+1}$ to $\Ta^n$?} : \Tm(\Gamma,(\U_{\s(n)})_\Gamma)
\end{eqnarray*}
The last operator symbol is the lifting (or cumulativity) operator. We have the following equations
\begin{eqnarray*}
\Tan((\N^n)_\Gamma) &=& \N_\Gamma\\
\Ta_n(\Pi^{n}(a,b)) &=& \Pi(\Ta_n(a),\Tan(b))\\
\Ta_{\s(n)}((\U^n)_\Gamma ) &=& (\U_n)_\Gamma\\
%&\Ta_{n+1}(\Ta_n^{n+1}(a)) &=& \Ta_n(a)\\
\Ta^{n+1}_n((\N^n)_\Gamma) &=& (\N^{\s(n)})_\Gamma\\
\Ta^{n+1}_n(\Pi^{n}(a,b)) &=& \Pi^{\s(n)}(\Ta^{n+1}_n(a),\Ta^{n+1}_n(b))
\end{eqnarray*}
Finally, all operator symbols commute with substitution:
\begin{eqnarray*}
{(\Un)}_\Gamma [ \gamma ] &=& {(\Un)}_\Delta\\
\Tan(a) [ \gamma ] &=& \Tan(a[ \gamma ] )\\
\N^n_\Gamma [ \gamma ] &=&\N^n_\Delta\\
\Pi^{n}(a,b)[ \gamma ] &=& \Pi^{n}(a [ \gamma ], b[ \gamma^+ ])\\
\U^n[\gamma] &=& \U^n\\
\Ta_n^{n+1}(a)[\gamma]  &=& \Ta_n^{n+1}(a[\gamma])
\end{eqnarray*}
Mention a la Russell initiality?

\subsection{Removing cumulativity} Agda, cumulativity up to equivalence.

\subsection{Cwfs with universe polymorphic tower structures} Here we need to extend the cwf-framework further to take into account contexts with level variables, etc.

\section{Related work}

Streicher, Brunerie for constructions of initial contextual categories supporting the calculus of constructions and Martin-LÃ¶f type theory (ordinary syntax, but with annotated application). Streicher shows that the annotations can be removed assuming we have a normal form property.

\footnote{Mention LF-encodings, mention work on initiality conjecture? Uemura}

Our $\T_\Sigma$ is closely related to Altenkirch and Kaprosi's quotient inductive-inductive types. Inductive-inductive types \cite{nordvallforsberg:phd} is a generalization of mutual inductive families, where one index set may depend on another. The motivating example is building the formal system of type theory by simultaneously defining contexts, substitutions depending on contexts, types depending on context, and terms depending on types and contexts. We can do so by considering the sort symbols of the gat of cwfs as formation rules and the operator symbols as introduction rules. A quotient inductive-inductive type is a combination of quotient types and inductive-inductive types, where there are also constructors witnessing equations. 

Our $\T_\Sigma$ differs from Altenkirch and Kaprosi's notion. The stipulated equations in $\Sigma$ generate judgmental equalities in a system for dependent type theory implementing $\T_\Sigma$. While the stipulated equations in quotient inductive-inductive types are propositional identities. Some of the cwf-equations depend on earlier equations. If these are propositional equalities we need to introduce transport maps between in the types. 

Altenkirch and Kaprosi's notion assumes a setting of intensional type theory, such as Agda's. They implement their notion in Agda.

Given that we have definition of a valid signature $\Sigma$ and a semantics for $\T_\Sigma$ we could ask whether we could add the construction of these to type theory. This would make most sense in extensional type theory, since we can then move seamlessly between propositional and judgmental equalities. It is however, not clear how to provide canonical form semantics in the sense of Martin-LÃ¶f's meaning explanations for this notion. However, although our development takes place in set theory, everything we do is constructive and could be formalized in CZF presumably.

\bibliographystyle{plain}
\bibliography{refs}
%\input{referenc}
\end{document}
